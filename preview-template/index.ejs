<html>
    <head>
        <link rel="icon" href="./favicon.ico" />
        <meta charset="utf-8" />
        <title><%=title%></title>
        <meta
            name="viewport"
            content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1,minimal-ui=true"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="full-screen" content="yes" />
        <meta name="screen-orientation" content="portrait" />
        <meta name="x5-fullscreen" content="true" />
        <meta name="360-fullscreen" content="true" />
        <meta name="renderer" content="webkit" />
        <meta name="force-rendering" content="webkit" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

        <link rel="stylesheet" type="text/css" href="./index.css" />
    </head>
    <body style="overflow: hidden;">
        <%- include(cocosToolBar, {config: config}) %>
        <div id="content" class="content" style="overflow: hidden;">
            <div class="contentWrap">
                <div id="GameDiv" class="wrapper">
                    <div id="Cocos3dGameContainer">
                        <canvas id="GameCanvas" tabindex="-1" style="background-color: '';"></canvas>
                    </div>
                    <div id="splash">
                        <div class="progress-bar stripes"><span></span></div>
                    </div>
                    <div id="bulletin">
                        <div id="sceneIsEmpty" class="inner"><%=tip_sceneIsEmpty%></div>
                    </div>
                    <div class="error" id="error">
                        <div class="title">Error <i>(Please open the console to see detailed errors)</i></div>
                        <div class="error-main"></div>
                        <div class="error-stack"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- <%- include(cocosTemplate, {}) %> -->
         
        <script>
            try {
                // 在启动加载之前先初始化显示错误遮罩的相关代码，才能更好的提示后续启动过程中可能出现的错误
                // 3.6.0 之前的预览模板只有 error-main
                const errorMain = document.querySelector('#error .error-main');
                const errorStack = document.querySelector('#error .error-stack');
                const errorWrap = document.querySelector('#error');
                function transToErrorInfo(error) {
                    const errorInfo = {
                        message: '',
                        stack: '',
                    };
                    if (error instanceof ErrorEvent) {
                        errorInfo.message = error.error.message;
                        errorInfo.stack = error.error.stack;
                    }
                    else if (error instanceof PromiseRejectionEvent) {
                        errorInfo.message = error.reason;
                    }
                    else if (error instanceof Event && error.target && error.target.src) {
                        errorInfo.message = `Get ${error.target.src} failed!`;
                    } else {
                        errorInfo.message = error.message;
                        errorInfo.stack = error.stack;
                    }
                    return errorInfo;
                }
                function showError(errorInfo, message) {
                    // if (!errorWrap) {
                    //     return;
                    // }
                    // message = message || '[Browser Preview]' + errorInfo.message + (errorInfo.stack ? '/n' + errorInfo.stack : '');
                    // if (errorStack) {
                    //     errorMain.innerText = errorInfo.message;
                    //     errorInfo.stack && (errorStack.innerText = errorInfo.stack);
                    // }
                    // else {
                    //     // 兼容 3.6.0 之前的预览模板
                    //     errorMain.innerText = message;
                    // }
                    // errorWrap.style.display = 'block';
                    return {
                        errorInfo,
                        message,
                    };
                }
                window.__errorTools = {
                    transToErrorInfo,
                    showError,
                }
                function installDiagnosisRoutine() {
                    const errorHandle = function (error) {
                        if (error.message && error.message.includes('debug-evaluate')) {
                            return;
                        }
                        console.error(error);
                        __errorTools.showError(__errorTools.transToErrorInfo(error));
                        // 注意，在返回 true 的时候，异常才不会继续向上抛出error;
                        return true;
                    };
                    // 全局捕获错误
                    window.addEventListener(
                        'error',
                        errorHandle,
                        true,
                    );
                    window.addEventListener(
                        'unhandledrejection',
                        (error) => {
                            console.error(error);
                            __errorTools.showError(__errorTools.transToErrorInfo(error));
                        },
                        true,
                    );
                }
                installDiagnosisRoutine();
            }
            catch (error) {
                console.error(error);
            }
        </script>
    </body>
</html>
